<!DOCTYPE html>
<html>
<head>
  <title>flappybird</title>
  <meta charset="utf-8">
  <style>
    * {
      margin: 0;
    }
    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: #f5f5f5;
    }
    canvas {
      display: block;
      border: 1px solid #ccc;
      margin: 20px auto;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <script src="https://kaboomjs.com/lib/0.5.0/kaboom.js"></script>
  <script src="https://kaboomjs.com/lib/0.5.0/plugins/aseprite.js"></script>
  <script src="https://kaboomjs.com/lib/0.5.0/plugins/pedit.js"></script>
  <script src="https://kaboomjs.com/pub/legacy/kbmsprite.js"></script>
  <script>
    kaboom({
      ...{"fullscreen":true,"width":240,"height":240,"scale":2,"startScene":"main","debug":true,"clearColor":null,"version":"0.5.0"},
      global: true,
      plugins: [ peditPlugin, asepritePlugin, kbmspritePlugin ],
    });

    loadSprite("bg", "sprites/bg.png");
    loadKbmsprite("mark", "sprites/mark.kbmsprite");
    loadSprite("pipo", "sprites/pipo.png");
    loadSound("hit", "sounds/hit.wav");
    loadSound("score", "sounds/score.wav");
    loadSound("wooosh", "sounds/wooosh.ogg");

    scene("main", (args = {}) => {
      const PIPO_OPEN = 96;
      const PIPO_MIN_HEIGHT = 16;
      const JUMP_FORCE = 200;
      const SPEED = 120;

      gravity(1200);

      layers([
        "bg",
        "obj",
        "ui",
      ], "obj");

      // background image
      add([
        sprite("bg"),
        scale(width() / 100, height() / 100),
        layer("bg"),
      ]);

      const birdy = add([
        sprite("mark"),
        pos(120, 0),
        layer("obj"),
        body(),
      ]);

      birdy.action(() => {
        if (birdy.pos.y >= height() || birdy.pos.y <= -120) {
          go("score", { score: score.value });
        }
      });

      keyPress("space", () => {
        birdy.jump(JUMP_FORCE);
        play("wooosh");
      });

      function spawnPipo() {
        const h1 = rand(PIPO_MIN_HEIGHT, height() - PIPO_MIN_HEIGHT - PIPO_OPEN);
        const h2 = h1 + PIPO_OPEN;

        add([
          sprite("pipo"),
          origin("botleft"),
          pos(width(), h1),
          layer("obj"),
          "pipo",
        ]);

        add([
          sprite("pipo"),
          origin("botleft"),
          scale(1, -1),
          layer("obj"),
          pos(width(), h2),
          "pipo",
          { passed: false },
        ]);
      }

      birdy.collides("pipo", () => {
        go("score", { score: score.value });
        play("hit");
      });

      action("pipo", (p) => {
        p.move(-SPEED, 0);
        if (p.pos.x + p.width <= birdy.pos.x && p.passed === false) {
          addScore();
          p.passed = true;
        }
        if (p.pos.x < -width() / 2) {
          destroy(p);
        }
      });

      loop(1, () => {
        spawnPipo();
      });

      const score = add([
        text("0", 16),
        layer("ui"),
        pos(9, 9),
        { value: 0 },
      ]);

      function addScore() {
        score.value++;
        score.text = score.value;
        play("score");
      }
    });

    scene("score", (args = {}) => {
      add([
        sprite("bg"),
        scale(width() / 100, height() / 100),
        layer("bg"),
      ]);

      const mark = add([
        sprite("mark"),
        scale(1),
        pos(width```
